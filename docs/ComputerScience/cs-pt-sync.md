---
layout: default
title: 동기화(Synchronization)
parent: 프로세스와 쓰레드
grand_parent: 컴퓨터공학(Computer Science)
nav_order: 9
---

{: .no_toc }
<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>

---

# 동기화 문제
동기화 문제는 서로 다른 쓰레드가 메모리 영역을 공유하기 때문에
여러 쓰래드가 동일한 자원에 동시에 접근하여 엉뚱한 값을 읽거나 수정하는 문제입니다.

atomic operation
cnt++ 을 cpu 입장에서 보면 3가지의 atomic operation 으로 나뉩니다.
01. cnt 의 변수값을 가져온다.
02. cnt 의 변수값을 증가시킨다.
03. 변경된 cnt 값을 저장한다.

시분할 시스템으로 작동하는 멀티프로세스/쓰레드 시스템에서,
두 개의 쓰래드가 동일한 데이터인 cnt 에 접근하여 조작을 하는 상황이라면!

쓰래드A 에서도 cnt++ 를 하고, 쓰래드B 에서도 cnt++ 을 한다면 실행 결과가
접근이 발생한 순서에 따라 달라질 수 있습니다. 이를 경쟁 상황(race condition)이라고 합니다.

즉 둘 이상의 쓰래드가 동일한 자원에 접근하여 조작하고,
그 실행 결과가 접근이 발생한 순서에 따라 달라지는 경쟁상황에 의해서
동기화 문제가 발생할 수 있습니다.

경쟁 상황으로부터 보호하기 위해,
우리는 한 순간에 하나의 프로세스/쓰데드만 해당 자원에 접근하고 조작할 수 있도록 보장해야합니다.
다시 말해서 프로세스/쓰레드들이 동기화되도록 할 필요가 있습니다.

## 임계영역(critical section)
둘 이상의 프로세스/쓰레드가 동시에 동일한 자원에 접근하도록 하는 프로그램 코드 부분을 말합니다.
중요한 특징 중 하나는, 한 프로세스/쓰레드가 자신의 임계구역에서 수행하는 동안에는
다른 프로세스/쓰레드들은 그들의 임계구역에 들어갈 수 없어야 한다는 사실입니다.
즉, 임계영역 내의 코드는 원자적(atomically) 실행 되어야합니다.

원자적으로 실행 되기 위해서 각각의 프로세스/쓰레드는
자신의 임계구역으로 진입하려면 진입 허가를 요청해야합니다.
이 부분을 entry section 이라고 하고, 진입이 허가되면 임계영역을 실행할 수 있습니다.
임계영역이 끝나면 exit section 으로 퇴출하게 됩니다.
임계영역의 원자성을 보장하여 프로세스/쓰레드들이 동기화되도록 할 수 있습니다.

동기화 방법으로는 대표적으로 뮤텍스와 세마포어가 있습니다.

멀티프로세스, 쓰레드 환경에서 동기화 문제를 해결하는 방법

동기화 문제를 해결하기 위해, mutex, semaphore 기법 등을 사용할 수 있습니다.

## 뮤텍스(Mutex)
동기화 방법중 하나로 mutual exclusion 의 축약어 입니다.
공유자원에 접근할 수 있는 프로세스/쓰레드를 1개로 제한합니다.

임계영역을 보호하고, 경쟁상황을 방지하기 위해 mutex lock 을 사용합니다.
프로세스와/쓰래드는 임계영역에 들어가기 전 반드시 lock 을 획득해야하고,
임계구역을 빠져나올 때 lock 을 반환해야합니다.
```java
acquire() // entry section
// 임계구역(critical section)
release() // exit section
```

mutex란 1개의 쓰레드만이 공유 자원에 접근할 수 있도록 하여, 경쟁 상황(race condition)을 방지하는 기법입니다.
공유 자원을 점유하는 쓰레드가 락을 걸면, 다른 쓰레드가 언락 상태가 될 때까지 해당 자원에 접근할 수 없습니다.

## 세마포어(Semaphore)
세마포어는 동기화 방법중 하나로, 뮤텍스(mutex) 와 가장 큰 차이점은
공유 자원에 접근할 수 있는 프로세스/쓰레드의 개수가 2개 이상 될 수 있다는 것입니다.

세마포어 변수 S(세마포) 에 동시에 접근 가능한 프로세스/쓰래드의 개수를 저장합니다.
S가 0보다 크면 임계영역으로 들어갈 수 있고, 임계영역에 들어가면 S값을 1 감소시킵니다.
S 값이 0이되면 프로세스/쓰래드들은 임계영역으로 접근할 수 없습니다.

임계영억에서의 작업이 끝나고 임계영역에서 exit 하면서 S값을 1증가 시킵니다.
```java

wait(s) // entry section
// 임계영역(critical section)
signal(s) // exit section

wait(s) {
    while(s <= 0);
    s--;
        }
        
signal(s) {
    s++;
        }
```
세마포어값이 0, 1 만 가질 수 있는 경우 binary semaphore 라고 하는데,
이는 mutex랑 거의 유사하게 작동합니다.


세마포어란 S 개의 쓰레드만이 공유 자원에 접근할 수 있도록 제어하는 동기화 기법입니다.
세마포어 기법에서는 정수형 변수 S(세마포) 값을 가용한 자원의 수로 초기화 하고,
자원에 접근할 때는 s-- 연산을 수행하여 세마포 값을 감소시키고
자원을 방출할 때는 s++ 연산을 수행하여 세마포 값을 증가시킵니다.
이 때 세마포 값이 0이 되면 모든 자원이 사용 중임을 의미하고
이후 자원을 사용하려는 프로세스는 세마포 값이 0 보다 커질때 까지 block 됩니다.

